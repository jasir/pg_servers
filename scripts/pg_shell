#!/bin/bash
# PostgreSQL Shell Function Setup
# P≈ôidej tento soubor do ~/.bashrc nebo ~/.zshrc:
# source ~/pg_servers/scripts/pg_shell

# Funkce pro p≈ôepnut√≠ PostgreSQL verze v aktu√°ln√≠m shellu
pguse() {
    local version="$1"
    local pg_servers_root="$HOME/pg_servers"

    if [ -z "$version" ]; then
        echo "‚ùå Chyb√≠ verze. Pou≈æit√≠: pguse <verze>"
        echo "Dostupn√© verze:"
        for dir in /usr/lib/postgresql/*; do
            if [ -d "$dir/bin" ]; then
                echo "  ‚Ä¢ $(basename "$dir")"
            fi
        done
        return 1
    fi

    local pg_path="/usr/lib/postgresql/$version/bin"

    if [ ! -d "$pg_path" ]; then
        echo "‚ùå PostgreSQL $version nen√≠ nainstalov√°n"
        echo "Spus≈•te: $pg_servers_root/scripts/pgctl install"
        return 1
    fi

    # Odebr√°n√≠ v≈°ech PostgreSQL bin√°rek z PATH
    export PATH=$(echo "$PATH" | sed 's|:/usr/lib/postgresql/[^/]*/bin||g')

    # P≈ôid√°n√≠ po≈æadovan√© verze na zaƒç√°tek PATH
    export PATH="$pg_path:$PATH"

    echo "‚úÖ PostgreSQL $version aktivn√≠ v aktu√°ln√≠m shellu"
    echo "üìç PATH: $pg_path"
    echo "üîç Verze psql: $(psql --version | head -1)"
}

# Alias pro pgctl use (pro zpƒõtnou kompatibilitu)
alias pgswitch='pguse'

# Funkce pro zobrazen√≠ aktu√°ln√≠ PostgreSQL verze
pgwhich() {
    local psql_path=$(which psql 2>/dev/null)
    if [ -n "$psql_path" ]; then
        local version=$(psql --version | head -1)
        echo "üêò $version"
        echo "üìç $psql_path"
    else
        echo "‚ùå PostgreSQL klient nen√≠ v PATH"
    fi
}

# Automatick√© naƒçten√≠ naposledy pou≈æit√© verze (voliteln√©)
# Pokud existuje soubor s posledn√≠ verz√≠, naƒçti ji
if [ -f "$pg_servers_root/.last_pg_version" ]; then
    last_version=$(cat "$pg_servers_root/.last_pg_version")
    if [ -n "$last_version" ] && [ -d "/usr/lib/postgresql/$last_version/bin" ]; then
        pguse "$last_version" > /dev/null 2>&1
    fi
fi